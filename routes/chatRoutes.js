const express = require("express");
const router = express.Router();
const { ChatMessage, User } = require("../models");
const { Op } = require("sequelize");

function initChatSocket(io) {
  const userSockets = new Map();

  io.on("connection", (socket) => {
    const { userId } = socket.handshake.query;
    console.log(`ğŸ”Œ Ù…Ø³ØªØ®Ø¯Ù… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³ÙˆÙƒÙŠØª: ${userId}`);

    if (!userSockets.has(userId)) userSockets.set(userId, []);
    userSockets.get(userId).push(socket.id);

    socket.on("sendMessage", async (data) => {
      try {
        const { senderId, receiverId, message } = data;

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const newMessage = await ChatMessage.create({
          senderId,
          receiverId: receiverId || null,
          message,
        });

        // Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒØ§Ù…Ù„Ø© Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„ ÙˆØ§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
        const fullMessage = await ChatMessage.findOne({
          where: { id: newMessage.id },
          include: [
            { model: User, as: "sender", attributes: ["id", "name"] },
            { model: User, as: "receiver", attributes: ["id", "name"] },
          ],
        });

        let recipients = [];

        if (!receiverId) {
          // Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø©: ÙƒÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† + Ø§Ù„Ù…Ø±Ø³Ù„ Ù†ÙØ³Ù‡
          const admins = await User.findAll({ where: { role: "admin" }, attributes: ["id"] });
          recipients = [...admins.map(a => a.id), senderId]; // <-- Ø£Ø¶Ù senderId Ù‡Ù†Ø§
        } else {
          // Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ©: Ø§Ù„Ù…Ø±Ø³Ù„ + Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
          recipients = [senderId, receiverId];
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†
        recipients.forEach(id => {
          const sockets = userSockets.get(id.toString()) || [];
          sockets.forEach(sid => io.to(sid).emit("newMessage", fullMessage));
        });

      } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:", error);
      }
    });

    socket.on("disconnect", () => {
      console.log(`âŒ Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„: ${userId}`);
      const sockets = userSockets.get(userId) || [];
      userSockets.set(userId, sockets.filter(id => id !== socket.id));
    });
  });
}

// ------------------- API -------------------

router.post("/sendMessage", async (req, res) => {
  try {
    const { senderId, receiverId, message } = req.body;

    if (!senderId || !message) {
      return res.status(400).json({ error: "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§Ù…Ù„Ø©" });
    }

    const finalReceiverId = receiverId && receiverId !== 0 ? receiverId : null;

    const newMessage = await ChatMessage.create({
      senderId,
      receiverId: finalReceiverId,
      message,
    });

    const fullMessage = await ChatMessage.findOne({
      where: { id: newMessage.id },
      include: [
        { model: User, as: "sender", attributes: ["id", "name"] },
        { model: User, as: "receiver", attributes: ["id", "name"] },
      ],
    });

    res.json(fullMessage);
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:", err);
    res.status(500).json({ error: err.message });
  }
});

router.get("/MessagesForUser/:userId", async (req, res) => {
  const { userId } = req.params;
  const user = await User.findByPk(userId);

  if (!user) return res.status(404).json({ error: "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" });

  let whereCondition;

  if (user.role === "admin") {
    whereCondition = {
      [Op.or]: [
        { senderId: userId },
        { receiverId: userId },
        { receiverId: null }, // Ø±Ø³Ø§Ø¦Ù„ Ø¹Ø§Ù…Ø©
      ],
    };
  } else {
    whereCondition = {
      [Op.or]: [
        { senderId: userId },
        { receiverId: userId },
      ],
    };
  }

  const messages = await ChatMessage.findAll({
    where: whereCondition,
    include: [
      { model: User, as: "sender", attributes: ["id", "name"] },
      { model: User, as: "receiver", attributes: ["id", "name"] },
    ],
    order: [["createdAt", "ASC"]],
  });

  res.json(messages);
});

router.get("/UsersWithLastMessage", async (req, res) => {
  try {
    const admins = await User.findAll({ where: { role: "admin" }, attributes: ["id"] });
    const adminIds = admins.map(a => a.id);

    const messages = await ChatMessage.findAll({
      where: {
        [Op.or]: [
          { senderId: { [Op.in]: adminIds } },
          { receiverId: { [Op.in]: adminIds } },
        ],
      },
      include: [
        { model: User, as: "sender", attributes: ["id", "name"] },
        { model: User, as: "receiver", attributes: ["id", "name"] },
      ],
      order: [["createdAt", "DESC"]],
    });

    const usersMap = new Map();

    messages.forEach(msg => {
      if (!adminIds.includes(msg.senderId) && msg.sender) {
        if (!usersMap.has(msg.senderId)) usersMap.set(msg.senderId, { user: msg.sender, lastMessage: msg });
      }
      if (!adminIds.includes(msg.receiverId) && msg.receiver) {
        if (!usersMap.has(msg.receiverId)) usersMap.set(msg.receiverId, { user: msg.receiver, lastMessage: msg });
      }
    });

    res.json(Array.from(usersMap.values()));
  } catch (error) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¹ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©:", error);
    res.status(500).json({ error: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¹ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©" });
  }
});

module.exports = { router, initChatSocket };
